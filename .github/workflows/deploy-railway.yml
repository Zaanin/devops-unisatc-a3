name: Deploy to Railway

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch para fazer deploy'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - feat/pipeline-sucesso
          - test/pr-com-erro

jobs:
  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Build Strapi
        run: pnpm build

      - name: Start Strapi
        env:
          HOST: 0.0.0.0
          PORT: 1337
          APP_KEYS: ImJMpHjnCdJw4ii7jZzCXQ==,Jg239VoMach6Fh2LAH6ydA==,LAdmPTwE8oqyVjAV4pCkBQ==,f1gPGngKmE5xhyDktSpCVw==
          API_TOKEN_SALT: X2d0C6rgXwWgwEZCslZN0A==
          ADMIN_JWT_SECRET: deEi8rGl7WB43uXiaYPaOg==
          TRANSFER_TOKEN_SALT: vhsZEWfU3anLONbLZXZfqg==
          JWT_SECRET: U2Nh9O8oDdw6gzXqWbg5Eg==
          DATABASE_CLIENT: sqlite
          DATABASE_FILENAME: .tmp/data.db
        run: |
          pnpm start &
          echo "Waiting for Strapi to start..."
          npx wait-on http://localhost:1337/admin --timeout 60000

      - name: Run Playwright tests
        run: pnpm test:e2e

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: test  # SÃ³ executa se os testes passarem
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service=${{ secrets.RAILWAY_SERVICE_NAME }}
      
      - name: Get deployment URL
        run: |
          echo "### ðŸš€ Deploy no Railway Completo!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch deployada:** ${{ github.event.inputs.branch || github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Acesse o dashboard Railway para ver a URL:" >> $GITHUB_STEP_SUMMARY
          echo "https://railway.app/project" >> $GITHUB_STEP_SUMMARY
